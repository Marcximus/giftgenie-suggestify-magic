import { writeFileSync } from 'fs';
import { join } from 'path';
import https from 'https';

async function fetchSlugs() {
  console.log('Fetching blog post slugs from sitemap...');

  try {
    // Fetch sitemap from the public URL (generated by Supabase function)
    const sitemapXml = await new Promise((resolve, reject) => {
      https.get('https://getthegift.ai/sitemap.xml', {
        headers: {
          'User-Agent': 'NextJS-Build-Script'
        }
      }, (res) => {
        if (res.statusCode !== 200) {
          reject(new Error(`Sitemap fetch failed: ${res.statusCode} ${res.statusMessage}`));
          return;
        }

        let data = '';
        res.on('data', (chunk) => { data += chunk; });
        res.on('end', () => { resolve(data); });
      }).on('error', reject);
    });

    console.log(`Fetched sitemap (${sitemapXml.length} bytes)`);

    // Extract all blog post URLs using regex
    // Looking for: <loc>https://getthegift.ai/blog/post/SLUG</loc>
    const blogUrlRegex = /<loc>https:\/\/getthegift\.ai\/blog\/post\/([^<]+)<\/loc>/g;
    const slugs = [];

    let match;
    while ((match = blogUrlRegex.exec(sitemapXml)) !== null) {
      slugs.push(match[1]);
    }

    console.log(`Found ${slugs.length} blog post slugs`);

    if (slugs.length === 0) {
      console.warn('WARNING: No blog post slugs found in sitemap!');
      console.warn('This means no blog posts will be pre-rendered at build time.');
      process.exit(1);
    }

    // Write to file for Next.js build to use
    const outputPath = join(process.cwd(), 'app', 'blog', 'post', 'slugs.json');
    writeFileSync(outputPath, JSON.stringify(slugs, null, 2));
    console.log(`✅ Wrote ${slugs.length} slugs to ${outputPath}`);
    console.log('First 5 slugs:', slugs.slice(0, 5));

    process.exit(0);
  } catch (error) {
    console.error('❌ Error fetching blog post slugs:', error.message);
    console.error('This will cause blog posts to NOT be pre-rendered at build time!');
    process.exit(1);
  }
}

fetchSlugs();
